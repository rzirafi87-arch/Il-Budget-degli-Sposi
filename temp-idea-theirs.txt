import React, { useState, useEffect, useMemo } from "react";
import { getBrowserClient } from "@/lib/supabaseServer";
import { getEventConfig, resolveEventType, DEFAULT_EVENT_TYPE } from "@/constants/eventConfigs";

type ContributorBudgets = Record<string, number>;

type SpendTypeOption = {
  value: string;
  label: string;
};
export default function IdeaDiBudgetPage() {
  const supabase = getBrowserClient();

  const [eventType, setEventType] = useState<string>(DEFAULT_EVENT_TYPE);
  const eventConfig = getEventConfig(eventType);

  const [rows, setRows] = useState<BudgetIdeaRow[]>([]);
  const [loading, setLoading] = useState(true);
  const [saving, setSaving] = useState(false);
  const [contributorBudgets, setContributorBudgets] = useState<ContributorBudgets>({});
  const [eventDate, setEventDate] = useState<string>("");
  const [currency, setCurrency] = useState<string>(() =>
    (typeof window !== "undefined" && localStorage.getItem("budgetIdea.currency")) || "EUR"
  );

  // Recupera il tipo di evento selezionato
  useEffect(() => {
    if (typeof window === "undefined") return;
    const cookieMatch = document.cookie.match(/(?:^|; )eventType=([^;]+)/)?.[1];
    const stored = window.localStorage.getItem("eventType");
    const resolved = resolveEventType(stored || cookieMatch || DEFAULT_EVENT_TYPE);
    setEventType(resolved);
  }, []);

  // Inizializza budget e data per il tipo di evento corrente
  useEffect(() => {
    if (typeof window === "undefined") return;
    const nextBudgets: ContributorBudgets = {};
    eventConfig.contributors.forEach(({ value }) => {
      const stored = window.localStorage.getItem(`budgetIdea.budget.${eventType}.${value}`);
      nextBudgets[value] = stored ? Number(stored) || 0 : 0;
    });
    setContributorBudgets(nextBudgets);
    const storedDate = window.localStorage.getItem(`budgetIdea.eventDate.${eventType}`) || "";
    setEventDate(storedDate);
  }, [eventConfig.contributors, eventType]);

  // Carica idee di budget reali da Supabase o genera struttura base
  useEffect(() => {
    async function fetchBudgetIdeas() {
      setLoading(true);
      const { data: sessionData } = await supabase.auth.getSession();
      const jwt = sessionData.session?.access_token;
      const headers: HeadersInit = {};
      if (jwt) headers["Authorization"] = `Bearer ${jwt}`;
      try {
        const res = await fetch("/api/idea-di-budget", { headers });
        const json = await res.json();
        if (json.data && Array.isArray(json.data) && json.data.length > 0) {
          const byKey = new Map<string, BudgetIdeaRow>();
          for (const r of json.data) {
            const category = r.categories?.name || r.category || "";
            const subcategory = r.subcategory || "";
            const key = `${category}|||${subcategory}`;
            const amount = Number(r.idea_amount ?? r.amount ?? 0) || 0;
            const rawSpendType = (r.spendType || r.spend_type || eventConfig.defaultSpendType) as string;
            const spendType = rawSpendType === "common" ? eventConfig.defaultSpendType : rawSpendType;
            const supplier = r.supplier || "";
            const notes = r.notes || "";
            if (!byKey.has(key)) {
              byKey.set(key, { category, subcategory, spendType, amount, supplier, notes });
            } else {
              const cur = byKey.get(key)!;
              cur.amount = (Number(cur.amount) || 0) + amount;
              if (!cur.supplier && supplier) cur.supplier = supplier;
              if (!cur.notes && notes) cur.notes = notes;
              if (cur.spendType === eventConfig.defaultSpendType && spendType !== eventConfig.defaultSpendType) cur.spendType = spendType;
            }
          }
          setRows(Array.from(byKey.values()));
        } else {
          const allRows: BudgetIdeaRow[] = [];
          Object.entries(eventConfig.budgetCategories).forEach(([category, subs]) => {
            subs.forEach((subcategory) => {
              allRows.push({
                category,
                subcategory,
                spendType: eventConfig.defaultSpendType,
                amount: 0,
                supplier: "",
                notes: "",
              });
            });
          });
          setRows(allRows);
        }
      } catch (error) {
        console.error("Errore caricamento idea di budget", error);
        const allRows: BudgetIdeaRow[] = [];
        Object.entries(eventConfig.budgetCategories).forEach(([category, subs]) => {
          subs.forEach((subcategory) => {
            allRows.push({
              category,
              subcategory,
              spendType: eventConfig.defaultSpendType,
              amount: 0,
              supplier: "",
              notes: "",
            });
          });
        });
        setRows(allRows);
      } finally {
        setLoading(false);
      }
    }
    fetchBudgetIdeas();
  }, [eventConfig, eventType, supabase]);

  // Persist semplice preferenze di visualizzazione
  const spendTypeLabelMap = useMemo(() => {
    const map = new Map<string, string>();
    spendTypeOptions.forEach((opt) => map.set(opt.value, opt.label));
    return map;
  }, [spendTypeOptions]);

  // Gestione input righe tabella
  function handleChange(idx: number, field: keyof BudgetIdeaRow, value: any) {
          <a
            href="/budget"
            className="inline-flex items-center gap-2 px-4 py-2 rounded-full border text-sm bg-white border-gray-300 hover:bg-gray-50"
          >
            <span aria-hidden>����</span> Torna a Budget
          </a>
          <a
            href="/dashboard"
            className="inline-flex items-center gap-2 px-4 py-2 rounded-full border text-sm bg-white border-gray-300 hover:bg-gray-50"
          >
            <span aria-hidden>����</span> Torna in Dashboard
          </a>
        </div>
      </div>

      <div className="mb-6 p-5 rounded-2xl border-2 border-gray-200 bg-white shadow-md">
        <h3 className="text-lg font-semibold mb-3">{eventConfig.budgetSectionTitle}</h3>
        <div className="grid grid-cols-1 sm:grid-cols-4 gap-4">
          {eventConfig.contributors.map((contributor) => (
            <div key={contributor.value}>
              <label className="block text-sm font-medium text-gray-700 mb-1">
                {contributor.label} (EUR)
              </label>
              <input
                type="number"
                className="border-2 border-gray-200 rounded-lg px-3 py-2 w-full"
                value={Number.isFinite(contributorBudgets[contributor.value]) ? contributorBudgets[contributor.value] : ""}
                onChange={(e) => handleBudgetChange(contributor.value, Number(e.target.value) || 0)}
                placeholder="Es. 1000"
              />
            </div>
          ))}
          <div>
            <label className="block text-sm font-medium text-gray-700 mb-1">{eventConfig.totalBudgetLabel} (EUR)</label>
            <input
              type="number"
              className="border-2 border-gray-300 bg-gray-100 rounded-lg px-3 py-2 w-full font-bold"
              value={totalBudget}
              readOnly
            />
          </div>
          <div>
            <label className="block text-sm font-medium text-gray-700 mb-1">{eventConfig.dateLabel}</label>
            <input
              type="date"
              className="border-2 border-[#A3B59D] rounded-lg px-3 py-2 w-full"
              value={eventDate}
              onChange={(e) => setEventDate(e.target.value)}
            />
          </div>
        </div>
        <div className="grid grid-cols-1 sm:grid-cols-3 lg:grid-cols-4 gap-4 mt-4">
          {eventConfig.contributors.map((contributor) => {
            const available = contributorBudgets[contributor.value] || 0;
            const planned = plannedBySpendType[contributor.value] || 0;
            const residue = Math.max(available - planned, 0);
            return (
              <div key={contributor.value} className={`rounded-xl ${contributor.cardClass} p-4`}>
                <h4 className="font-semibold mb-1">{contributor.label}</h4>
                <div className="text-sm text-gray-700">Disponibile: �� {available.toLocaleString()}</div>
                <div className="text-sm text-gray-700">Speso (pianificato): �� {planned.toLocaleString()}</div>
                <div className="text-sm font-semibold text-emerald-700">Residuo: �� {residue.toLocaleString()}</div>
              </div>
            );
          })}
          <div className="rounded-xl border-2 border-gray-300 bg-gray-50 p-4">
            <h4 className="font-semibold mb-1">{eventConfig.totalBudgetLabel}</h4>
            <div className="text-sm text-gray-700">Disponibile: �� {totalBudget.toLocaleString()}</div>
            <div className="text-sm text-gray-700">Speso (pianificato): �� {plannedTotal.toLocaleString()}</div>
            <div className="text-sm font-semibold text-emerald-700">
              Residuo: �� {Math.max(totalBudget - plannedTotal, 0).toLocaleString()}
            </div>
            {extraSpendItems.length > 0 && (
              <div className="mt-3 text-xs text-gray-600">
                <p className="font-semibold mb-1">Altri contributi:</p>
                <ul className="space-y-1">
                  {extraSpendItems.map(({ value, amount }) => (
                    <li key={value}>
                      {spendTypeLabelMap.get(value) || value}: �� {amount.toLocaleString()}
                    </li>
                  ))}
                </ul>
              </div>
            )}
                <label className="block text-sm font-medium mb-1">Valuta</label>
                <input
                  type="text"
                  value={currency}
                  onChange={(e) => setCurrency(e.target.value)}
                  className="w-24 border rounded px-2 py-1"
                  maxLength={4}
                />
              </div>
              <div>
                <label className="block text-sm font-medium mb-1">Imprevisti (%)</label>
                <input
                  type="number"
                  min={0}
                  max={50}
                  value={contingencyPct}
                  onChange={(e) => setContingencyPct(Number(e.target.value))}
                  className="w-28 border rounded px-2 py-1"
                />
              </div>
              <div className="sm:col-span-2 flex items-center gap-3">
                <input
                  id="compactView"
                  type="checkbox"
                  checked={compactView}
                  onChange={(e) => setCompactView(e.target.checked)}
                  className="h-4 w-4"
                />
                <label htmlFor="compactView" className="text-sm">
                  Vista compatta (righe pi+� strette)
                </label>
                    <div>
                      <strong>Totale ipotizzato:</strong> {currency} {base.toLocaleString()}
                    </div>
                    <div>
                      <strong>Imprevisti:</strong> {currency} {extra.toLocaleString()} ({contingencyPct}%)
                    </div>
                    <div>
                      <strong>Totale con imprevisti:</strong> {currency} {total.toLocaleString()}
                    </div>
                <th className="p-2">Categoria</th>
                <th className="p-2">Sottocategoria</th>
                <th className="p-2">Fornitore</th>
                <th className="p-2">Importo ({currency})</th>
                <th className="p-2">{eventConfig.spendTypeLabel}</th>
                <th className="p-2">Note</th>
                      {spendTypeOptions.map((st) => (
                        <option key={st.value} value={st.value}>
                          {st.label}
                        </option>